<html>

<head>
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'none';script-src 'self' https://cdnjs.cloudflare.com 'unsafe-inline';style-src https://cdnjs.cloudflare.com 'unsafe-inline';connect-src 'self';img-src data: blob:">
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-site-verification" content="E0kIU_hp-oRr9MAMKFwYK1roAdtBq9hEkCy-DPiG1l8" />
    <title>RtxData - Анализ данных из Райфайзен Банка (Сербия)</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.26.0/plotly.min.js"
        integrity="sha512-mS3oJ3NDBADQBxpBYuK/jqeQysit9+O0FWhsxprErA1xluQNlxmUmTaACrZMBoTAmOu0Zn4AR4ao17226DUNlA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"
        integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js"
        integrity="sha512-sijCOJblSCXYYmXdwvqV0tak8QJW5iy2yLB1wAbbLc3OOIueqymizRFWUS/mwKctnzPKpNdPJV3aK1zlDMJmXQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-asm.js"
        integrity="sha512-rmkykIfjko0kedpism7nBHHSJKyB9/Ake2ihqff5QpUSVy3fy5Da7U5chQKtzXGAXEmNqrQ25t+NJIlFh3LoNg=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css"
        integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        body,
        input {
            font-size: 18px;
        }

        .content {
            margin: 10px 0;
        }

        table {
            border-collapse: collapse;
        }

        th,
        td {
            border: 1px solid #000;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        tr:hover {
            background-color: #f5f5f5;
        }

        pre {
            font-size: 12px !important;
        }

        #nav {
            display: flex;
            flex-direction: column;
        }
    </style>
</head>

<body>
    <h3><a href="#">RtxData</a></h3>
    <div class="content">
        Анализ данных из Райфайзен Банка (Сербия)
        <button onclick="runCustomSql()">Выполнить SQL</button>
    </div>
    <div class="content" id="extension" style="display: none;">
        <button onclick="openRaiff()">Загрузить с raiffeisenbank.rs</button>
        <button onclick="openWolt()">Загрузить с wolt.com</button>
    </div>
    <div class="content">
        <button onclick="fileinput.click()">Импорт данных из json</button>
        <a href="https://github.com/rtxdata/rtxdata.github.io#скачиваем-свои-данные">Где их взять?</a>
    </div>
    <div class="content" id="ls"></div>
    <div class="content">
        <button onclick="localStorage.clear();location.hash = '';location.reload()">Очистить локальное
            хранилище</button>
    </div>
    <div class="content">
        <input type="checkbox" id="pieNoSum" onchange="pieNoSumChanged()">
        <label for="pieNoSum">Скрыть суммы на круговых диаграммах</label>
    </div>
    <input id="fileinput" type="file" accept=".json" style="display: none;" />
    <nav id="nav"></nav>
    <div id="results"></div>
    <script>
        function printLs() {
            const names = Object.keys(localStorage).filter(k => k.endsWith('.json'));
            if (names.length === 0) { return };

            for (let name of names) {
                const div = document.createElement("div");

                const dl = document.createElement("a");
                dl.innerText = `${name}`;
                dl.href = "#";
                dl.addEventListener("click", () => {
                    const element = document.createElement('a');
                    element.href = URL.createObjectURL(new Blob([localStorage[name]], { type: "application/json" }));
                    element.download = name;
                    element.click();
                });
                div.appendChild(dl);

                div.appendChild(document.createTextNode(` (${(localStorage[name].length * 2 / 1024 / 1024).toFixed(2)} MB) `));

                const del = document.createElement("a");
                del.innerText = `Удалить`;
                del.href = "#";
                del.addEventListener("click", () => {
                    delete localStorage[name];
                    location.hash = '';
                    location.reload();
                });
                div.appendChild(del);

                ls.appendChild(div);
            }
        }

        function scroll() {
            const element = document.getElementById(decodeURIComponent(location.hash.substring(1)));
            if (element) { element.scrollIntoView(); }
        }

        function pieNoSumChanged() {
            localStorage.pieNoSum = pieNoSum.checked ? '1' : '0';
            location.hash = '';
            location.reload();
        }

        function runCustomSql() {
            const customQuery = prompt("Введите SQL запрос", localStorage.sql || "SELECT * FROM TX;");
            if (customQuery !== null) {
                localStorage.sql = customQuery;
                results.innerHTML = '';

                dashboard({ [customQuery]: customQuery });
                document.querySelector("#nav").innerHTML = '';
            }
        }

        function handleGlobalError(e) {
            console.error(e);
            results.innerText = `Ошибка: ${e}`;
        }

        function display(item, type = 'div') {
            if (item instanceof HTMLElement) {
                results.appendChild(item);
            } else {
                const element = document.createElement(type);
                element.innerText = String(item);
                element.id = String(item);
                results.appendChild(element);
            }
        }

        function displayHeader(text) {
            const a = document.createElement('a');
            const h3 = document.createElement('h3');

            a.innerText = h3.id = h3.innerText = text;
            a.href = "#" + encodeURIComponent(a.innerText);
            document.querySelector("#nav").appendChild(a);
            results.appendChild(h3);
        }

        function displayQuery(query) {
            const queryDiv = document.createElement("div");
            queryDiv.innerHTML = '<pre><code class="language-sql"></code></pre>';
            queryDiv.querySelector('code').innerText = query;
            display(queryDiv);
        }

        function formatDateString(date) {
            const [d, m, y] = date.split(' ')[0].split('.');
            return `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
        }

        function formatDateTime(date) {
            const yyyy = date.getFullYear();
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const dd = String(date.getDate()).padStart(2, '0');
            const hh = String(date.getHours()).padStart(2, '0');
            const mi = String(date.getMinutes()).padStart(2, '0');
            const ss = String(date.getSeconds()).padStart(2, '0');

            return `${yyyy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
        }

        function parseRef(ref) {
            for (let type in patterns) {
                for (let key in patterns[type]) {
                    if (ref.includes(key)) {
                        return [type, patterns[type][key]];
                    }
                }
            }
            return ["other", ref];
        }

        function getQueries() {
            const [initQuery, ...dash] = dashboardSQL.split('\n-- ')
            const queries = { initQuery: initQuery };

            dash.forEach(item => {
                const [name, ...lines] = item.split('\n');
                const query = lines.join('\n').trim();
                if (query !== '') {
                    queries[name] = query;
                }
            });

            return queries
        }

        function displayDatePlot(df, title) {
            const div = document.createElement('div');
            display(div);

            const dataObj = Object.fromEntries(df.values), dates = df.values.map(e => new Date(e[0]));
            const minDate = new Date(Math.min(...dates)), maxDate = new Date(Math.max(...dates));
            const x = [], y = [];

            for (let dt = minDate; dt <= maxDate; dt.setDate(dt.getDate() + 1)) {
                const strDate = new Date(dt).toISOString().split('T')[0];
                x.push(strDate);
                y.push(dataObj[strDate] || 0);
            }

            Plotly.newPlot(div, [{ type: 'scatter', mode: 'lines', x, y, line: { shape: 'linear' } }],
                { title, xaxis: { title: '' }, yaxis: { title: '' } });
        }

        function displayTotalPie(df, title) {
            const div = document.createElement('div');
            display(div);

            Plotly.newPlot(div, [{
                type: 'pie',
                labels: df.values.map(d => d[0]),
                values: df.values.map(d => d[1]),
                textinfo: pieNoSum.checked ? 'percent' : 'value+percent'
            }], { title, width: 700 });
        }

        function displayTable(df, title) {
            const table = document.createElement('table');
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            df.columns.forEach(header => {
                const th = document.createElement('th');
                th.innerText = header;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            df.values.forEach(row => {
                const tr = document.createElement('tr');
                row.forEach(value => {
                    const td = document.createElement('td');
                    td.innerText = value;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);
            display(table);
        }

        function dashboard(queries) {
            for (let item in queries) {
                try {
                    const queryText = queries[item];
                    const df = query(queryText);

                    displayHeader(item);
                    displayQuery(queryText);

                    if (!df || df.values.length === 0) {
                        display('Нет данных')
                    } else if (df.columns.length === 2 && df.columns[0] === 'date') {
                        displayDatePlot(df, item);
                    } else if (df.columns.length === 2 && df.columns[1] === 'total') {
                        displayTotalPie(df, item);
                    } else {
                        displayTable(df, item);
                    }
                } catch (e) {
                    console.error(e);
                    display(`Ошибка ${e}`);
                }
            }

            Prism.highlightAll();
            scroll();
        }

        function query(sqlQuery) {
            const result = db.exec(sqlQuery);
            if (result.length === 0) { return null; }

            const { columns, values } = result[result.length - 1];
            return { columns, values };
        }

        function initDatabase(initQuery) {
            db.exec(`CREATE TABLE TX (id TEXT PRIMARY KEY, sum REAL NOT NULL, rsum REAL NOT NULL, curr TEXT NOT NULL, kat1 TEXT NOT NULL, kat2 TEXT, date DATE NOT NULL, type TEXT NOT NULL, card TEXT NOT NULL, ref TEXT, ref2 TEXT, acc TEXT NOT NULL);`);

            for (let file of Object.keys(localStorage).filter(k => k.startsWith('Raiff_') && k.endsWith('.json'))) {
                const data = JSON.parse(localStorage[file]);
                for (let account in data.transactions) {
                    for (let tx of data.transactions[account][0][1]) {
                        const date = formatDateString(tx[3]);
                        const ref = tx[6] === tx[14] ? tx[6] : tx[6] + " " + tx[14];
                        const sum = tx[8] === '0' ? parseFloat(tx[9]) : -1 * parseFloat(tx[8]);
                        const [kat1, kat2] = parseRef(ref.toLowerCase());
                        const curr = tx[2];
                        const txn = [tx[7], sum, sum * ratesRsd[curr], curr, kat1, kat2, date, tx[13], tx[5], ref, tx[11], account]

                        db.exec("INSERT OR IGNORE INTO TX (id, sum, rsum, curr, kat1, kat2, date, type, card, ref, ref2, acc) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);", txn);
                    }
                }
            }

            db.exec(`CREATE TABLE WOLT (id INTEGER, total REAL NOT NULL, date DATE NOT NULL, shop TEXT NOT NULL, curr TEXT NOT NULL, count INTEGER NOT NULL, item TEXT NOT NULL, price REAL NOT NULL);`);

            for (let file of Object.keys(localStorage).filter(k => k.startsWith('Wolt_') && k.endsWith('.json'))) {
                const { orders } = JSON.parse(localStorage[file]);

                for (let { order_number, venue_name, payment_time, items, currency, total_price, status } of orders) {
                    if (status !== 'delivered') {
                        continue;
                    }

                    const shop = venue_name;
                    const datetime = formatDateTime(new Date(payment_time['$date']));

                    for (let { count, name, price } of items) {
                        const order = [parseInt(order_number), total_price / 100, datetime, shop, currency, count, name, price / 100];
                        db.exec("INSERT INTO WOLT (id, total, date, shop, curr, count, item, price) VALUES (?, ?, ?, ?, ?, ?, ?, ?);", order);
                    }
                }
            }

            db.exec(`CREATE TABLE GLOVO (date DATE NOT NULL, shop TEXT NOT NULL, price REAL NOT NULL);`);

            for (let file of Object.keys(localStorage).filter(k => k.startsWith('Glovo_') && k.endsWith('.json'))) {
                const { glovo } = JSON.parse(localStorage[file]);

                for (let { creationTime, storeName, pricingBreakdown } of glovo) {
                    const total = pricingBreakdown.lines.filter(i => i.type === "TOTAL")[0].amount;
                    if (!total.includes(" дин.")) { continue; }

                    const price = +total.replaceAll(".", "").replace(",", ".").split(" ")[0];
                    const datetime = formatDateTime(new Date(creationTime));

                    db.exec("INSERT INTO GLOVO (date, shop, price) VALUES (?, ?, ?);", [datetime, storeName, price]);
                }
            }

            db.exec(initQuery);
        }

        async function init() {
            const SQL = await initSqlJs({});
            patterns = await fetch("./patterns.json").then(res => res.json());
            dashboardSQL = await fetch("./dashboard.sql").then(res => res.text());
            db = new SQL.Database();

            const { initQuery, ...queries } = getQueries();
            initDatabase(initQuery);
            dashboard(queries);
        }

        function save(key, value) {
            try {
                localStorage[key] = value;
                location.hash = '';
                location.reload();
            } catch (e) {
                handleGlobalError(e);
            }
        }

        function extensionActive() {
            document.querySelector("#extension").style.display = '';
        }

        let db, patterns, dashboardSQL;
        const ratesRsd = { "RSD": 1, "EUR": 117, "USD": 110 };

        try {
            navigator?.serviceWorker?.register('/sw.js');

            const results = document.querySelector("#results");
            const fileinput = document.querySelector('input[type=file]');
            const pieNoSum = document.querySelector('#pieNoSum');
            const ls = document.querySelector('#ls');

            pieNoSum.checked = localStorage.pieNoSum === '1';
            printLs();

            fileinput.addEventListener('change', ({ target }) => {
                const file = target.files[0];
                reader = new FileReader();
                reader.onload = ({ target }) => save(file.name, target.result);
                reader.readAsText(file);
            });
        } catch (e) {
            handleGlobalError(e);
        }

        init().catch(handleGlobalError);
    </script>
</body>

</html>